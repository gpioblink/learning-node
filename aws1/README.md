# DAY3 (DAY2と並行)

「AWSによるサーバーレスアーキテクチャ」を読破する。
作ったサンプルコードやテストコードはここにあげる。

## 本の構成

1. サーバレスの基本原則・主なアーキテクチャとパターン
2. 認証・認可、AWS Lambda、Amazon API Gateway
3. 実用的なその他サービス・アーキテクチャ(Amazon S3, Firebase)

## Chapter 1

- サーバレスの特徴は、開発者がサーバーやインフラを気にかけずにコードに全力を注げるようにすること。

- SOA(サービス指向アーキテクチャ)とはシステムは多くの独立したサービスにより組み立てられるということを明確に概念化したアーキテクチャ。マイクロサービスとサーバレスアーキテクチャはこのSOAの精神を受け継いでいる。特定のテクノロジーを強要するものではなく、メッセージのやりとりにより通信し、メッセージの作成・交換の方法を定義したスキーマやコントラクトを持つサービスを作るべきとするアーキテクチャ上のアプローチ。

- マイクロサービスとは、特定のビジネス目的や機能を中心として構築された小さくスタンドアローンで完全に独立したサービス。さまざまな汎用言語やドメイン固有言語で賭けるため言語や仕事にあったライブラリを選べる利点があるが、まともな計画がないとトランザクション管理や複雑なエラー修復のため話が難しくなる。

- サーバレスアーキテクチャでは、マイクロサービスの原則をたくさん取り入れても、少しだけ取り入れても構わないようにできている。

- ソフトウェア設計は、現在は階層設計が好まれる。階層化すると個々の問題が切り離され、メンテナンスしやすいアプリケーションを作れる。ただし、多くなりすぎると複雑になる。サーバレスアーキテクチャはそれを解決する。

- ティアはシステムの大きなコンポーネントを分離するためのモジュール境界。同じティアにまとめられるコンポーネントでも、物理的に別インフラに配置されることがある。例えば、ユーザーから見えるプレゼンテーションティアは、ビジネスロジックを含むアプリケーションから分離されている。データティアはデータを管理・永続化し、データのアクセスを提供するシステム。

- レイヤーは、アプリケーションの特定の機能を実行する論理的な断片。個々のティアは複数の階層を持ち、それらの階層はドメインサービスなどの別々の機能の処理を任される。

- ティア(層)の中に複数のレイヤー(階層)がある。

- サーバレスのアプローチは、階層化の問題や、更新が多くなりすぎる問題や土台の解決をしてくれるわけではないが、正しく実装することで複雑さを軽減し、整理し、管理するチャンスが得られる。

- 従来はプレゼンテーションティア（フロントエンド）、アプリケーションティア・データティア（バックエンド）であった。サーバレスアーキテクチャでは従来型のシステムのようなバックエンドは存在せず、プレゼンテーションティアが直接サービスやデータベース、APIGateWayを通したコンピュート関数にアクセスする。

- サーバレスアーキテクチャの原則５「オンデマンドでコードを実行するために、（サーバーではなく）コンピューティングサービスを使う」「目的が１つでストレートな関数を書く」「プッシュベースのイベント駆動パイプラインを設計する」「より厚くより強力なフロントエンドを作る」「サードパーティサービスを活用する」

- オンデマンドでコードを実行するために、コンピューティングサービスを使う。SOAの考え方を自然な形で拡張したもの。単独で独立して実行されるので、すべてのカスタムコードがAWS Lambdaのようなステートレスなコンピューティングサービスで実行できる。カスタムコードの多くは粒度の細かい関数として記述されるので、データソースの読み書き、他関数の呼び出し、関数の実行など、一般的なタスクの大半を実行するために関数を開発者は楽に書くことができる。複雑なタスクも、複雑なパイプラインをつくり複数の関数呼び出しをオーケストレートして扱える。

- 目的が１つでストレートな関数を書く。単一責任原則(Single Responsibility Principle)を念頭に置いて関数を設計すべき。たった１つだけのことをする堅牢で副作用の少ない関数をかく。これを守ることによって、複雑なバックエンドシステムでも管理しやすく理解しやすい状態になる。AWS Lambdaなどコンピューティングサービスを対象とするコードは、今あるセッションを超えたリソースやプロセスの生き残っていることを前提とせず、ステートレスなスタイルで書くべき。ステートレスなコードを書くことは、入力イベント、リクエストのかずに応じてすばやくスケーリングできるなど強力である。

- プッシュベースのイベント駆動パイプラインを設計する。プッシュベースのイベント駆動システムは、変更をポーリングするためのコードが不要なため、コストが下がり複雑さが軽減される。また、ユーザーエクスペリエンス自体がスムースになる場合もある。ただし、プッシュベースのイベント駆動モデルは、実現が不可能な場合があり、イベントソースをポーリングする場合、スケジュールに従って実行されるLambda関数が必要な場合もある。

- AWS LambdaとはNode.js,Python,C#,Javaのいずれかで書かれたコードを実行するコンピューティングサービス。ソースコードはzipにまとめられ、コンテナにデプロイされる。コード、設定、依存ファイルの組み合わせ全体をLambda関数と呼ぶ。AWS Lambdaはプッシュ、プルの両イベントモデルをサポートして多くのAWSサービスと統合されている。類似サービスとしてMicrosoft Azure Functions, IBM Bluemix, OpenWhisk, Google Cloud Functionsといったコンピューティングサービスもある。

- サーバレスアーキテクチャの設計スタイルの例(プッシュベースパイプライン):「S3(新しい動画のアップロード),S3バケットに動画をアップロードすると、AWSでイベントがトリガリングされLambda関数が起動する」「Lambda関数(トランスコードジョブの作成),ソースファイルから新しい動画ファイルを作るElasticTranscoderジョブを返す」「AmazonElasticTranscoder(動画のトランスコード),トランスコードサービスがジョブを実行し、新しい動画をエンコードする」「S3(新しい動画の保存),エンコード済みの動画が、AmazonElasticTranscoderによって新しいS3バケットに保存され別のイベントがトリガリングされる」「Lambda関数(メタデータの更新),イベントに対して別のLambda関数が反応し、データベースに書き込まれた動画のメタデータを作成する」「データベース(メタデータのデータベースへの保存)」「Lambda関数(通知の作成),データベース変更をきっかけに自動的にメール通知を作成するLambda関数が呼び出される)」「通知サービス(通知のディスパッチ)」

- より厚くより強力なフロントエンドを作る。AWS Lambdaで実行されるカスタムコードは、サービス料金がリクエスト数・実行時間・割り当てられたメモリーのサイズによって決まるためすばやく実行できるないといけない。そのため、複雑なバックエンドではなく、サードパーティサービスと直接やりとり可能な豊かなフロントエンドを作ればよい。これは、ユーザーエクスペリエンスの向上にもつながる。オンラインリソース間のポップ数が減りレイテンシが下がると、アプリケーションのパフォーマンスやユーザビリティが改善される。例えば、フロントエンドは、検索プロバイダ・データベース・その他役に立つAPIと直接通信することもできる。電子署名されたトークンを使えば、フロントエンドはデータベースなど様々なサービスとセキュアにやりとりすることができる。ただし、機密情報の処理にはフロントは信用できないので、データチェック・セキュリティやアクションの調整のためにコンピューティングサービスを使うべきである。また、フロントの処理が途中で失敗すると、整合性が取れていない状態になるので、失敗したオペレーションを再度実行できるようにするLambda関数が使うべきである。

- サードパーティサービスを活用する。自分に与えられた時間は、誰かがすでに実装した機能を改めて作るのではなく、自分の領域に固有な問題を解決することに使うべき。新たに自作することを自己目的化するべきではない。「巨人の肩の上に立つ」べき。もちろん、サードパーティサービスを検討するときは、価格、性能、可用性、ドキュメント、サポートなどの要素を評価しようね！

- サーバーからサーバーレスに乗り換えるときは、モノシックなコードを少しずつ切り出し、アプリケーションとやりとりできるLambda関数を作っていけばよい。移行作業の際は、古いコードに依存する制約などでうまく動かないことがあるので、システムの一部や全部をサーバレスにしたときどのように機能するかについてテストするプロトタイプを作るとよい。サーバレス化が厳しいときは、スケーリングが難しくなるなどありおすすめはできないが、モノシックとサーバレスのハイブリッドシステムを作ることもできる。また、移行作業には時間がかかるので、事前にテストプランとDevOps戦略を用意するべきである。

- なんでもかんでもサーバレスにするのは厳しい。例えば、具体的なSLA(Service Level Agreement)のもとでレイテンシーに厳しい規則があったりすると対応しにくい。以下に採用の判断基準をあげる

- サーバーレス採用の判断基準としては次の５つの観点がある。「万能でないサーバレス」「サービスレベル」「カスタマイズ」「ベンダーロックイン」「脱中央集権化」。

- 万能でないサーバレス。パブリッククラウドで実行されるので、銀行のオンラインシステムや生命維持装置などミッションクリティカル(重要,重大)なアプリケーションを作るべきではない。どうしてもサーバレスにしたいなら、プライベートクラウドを独自に用意し、サービス提供能力や信頼性の要件を満たすと良い。

- サービスレベル。AWSにはSLAがあるサービスとないサービスがあるので、これが判断材料の１つになる。大規模な案件になるとSLAのニーズに答えられないことがある。

- カスタマイズ。AWS LambdaはAmazonにプラットフォームとスケーリングを任せるので効率が上がるが、OSのカスタマイズやその下のインスタンスの調整は犠牲になる。AWSの場合は、RAMの容量やタイムアウトくらいしか変更できない。

- ベンダーロックイン。そのサービスを使うことでアーキテクチャはそのプラットフォームに密結合する危険性が高まる。

- 脱中央集権化。リモート呼び出しやエラー処理にサーバレス独特な処理が必要になることもある。サーバレスは分散的な性質を持つので、サーバレス固有の問題が起きることがある。

- サーバレスには次のような５つの利点がある「サーバー不要」「多くの用途」「低コスト」「コード量の削減」「スケーラブルで柔軟」

- サーバー不要：サーバーの構成や管理、パッチ、メンテナンスはベンダーが行ってくれる。自分は自社のコードだけに責任を負えばいい。多くの用途：ステートレスでスケーラビリティが高いため、並列処理が効果的である問題の解決に使える。低コスト：スケーリングの単位が細かく、無駄なコストがかかりにくい。コード量の削減：高い層のバックエンドシステムを用意できる。コード量の削減：従来型のシステムと比べてコードの複雑さを軽減するチャンスが生まれる。スケーラブルで柔軟：サーバレスシステムは従来型のシステムより簡単にスケーリングできる。
